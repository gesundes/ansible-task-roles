---
- name: CSTATE | Append intel_idle.max_cstate={{ cstate_maxcstate }} processor.max_cstate={{ cstate_maxcstate }} to grub default config
  ansible.builtin.lineinfile:
    state: present
    path: /etc/default/grub
    regexp: '^(GRUB_CMDLINE_LINUX=").*'
    line: '\1intel_idle.max_cstate={{ cstate_maxcstate }} processor.max_cstate={{ cstate_maxcstate }}"'
    backrefs: true
  register: grub_update_result
  
- name: CSTATE | Results of grub default config update
  ansible.builtin.debug:
    msg: "{{ grub_update_result.msg }}"

- name: CSTATE | Update grub config
  ansible.builtin.command:
    cmd: update-grub
  when: grub_update_result.changed
  notify: VM reboot
